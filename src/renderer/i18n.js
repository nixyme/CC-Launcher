// === i18n — Internationalization Module ===
let currentLocale = 'en';

const translations = {
  en: {
    'sidebar.title': 'Projects',
    'sidebar.newProject': 'New Project (⌘N)',
    'sidebar.search': 'Search projects...',
    'welcome.title': 'CC Launcher',
    'welcome.subtitle': 'Select a project or create a new one',
    'welcome.shortcut': 'to add project',
    'details.edit': 'Edit',
    'details.delete': 'Delete',
    'details.projectPath': 'Project Path',
    'details.outputPath': 'Output Path',
    'details.open': 'Open',
    'details.commands': 'Commands',
    'modal.newProject': 'New Project',
    'modal.editProject': 'Edit Project',
    'modal.projectName': 'Project Name',
    'modal.projectNamePlaceholder': 'My Project',
    'modal.projectPath': 'Project Path',
    'modal.selectProjectFolder': 'Select project folder',
    'modal.browse': 'Browse',
    'modal.commands': 'Commands',
    'modal.addCommand': '+ Add Command',
    'modal.outputPath': 'Output Path',
    'modal.selectOutputFolder': 'Select output folder (optional)',
    'modal.cancel': 'Cancel',
    'modal.save': 'Save',
    'modal.browseFile': 'Browse file',
    'modal.cmdName': 'Name',
    'details.cmdName': 'Name',
    'action.run': 'Run',
    'msg.loadFailed': 'Failed to load projects',
    'msg.noMatch': 'No matching projects',
    'msg.noProjects': 'No projects yet',
    'msg.emptyCommand': 'Command cannot be empty',
    'msg.fillAllFields': 'Please fill all fields and add at least one command',
    'msg.projectUpdated': 'Project updated',
    'msg.projectAdded': 'Project added',
    'msg.saveFailed': 'Save failed',
    'msg.deleteTitle': 'Delete Project',
    'msg.deleteConfirm': 'Are you sure you want to delete "{name}"? This cannot be undone.',
    'msg.projectDeleted': 'Project deleted',
    'msg.deleteFailed': 'Delete failed',
    'msg.launching': 'Launching terminal...',
    'msg.launched': 'Command launched in terminal',
    'msg.execFailed': 'Execution failed',
    'msg.exportFailed': 'Export failed',
    'msg.exported': 'Settings exported',
    'msg.invalidJson': 'Invalid JSON file',
    'msg.imported': 'Imported {imported}, skipped {skipped}',
    'msg.importFailed': 'Import failed',
    'msg.minOneCommand': 'At least one command required',
    'confirm.cancel': 'Cancel',
    'confirm.delete': 'Delete',
    'sidebar.settings': 'Settings',
    'settings.title': 'Settings',
    'settings.autoLaunch': 'Launch at startup',
    'settings.autoLaunchDesc': 'Automatically start when you log in',
    'settings.autoLaunchOn': 'Auto-launch enabled',
    'settings.autoLaunchOff': 'Auto-launch disabled',
    'settings.update': 'Software update',
    'settings.upToDate': "You're up to date",
    'settings.checkUpdate': 'Check',
    'settings.checking': 'Checking...',
    'settings.newVersion': 'v{version} available',
    'settings.download': 'Download',
    'settings.downloading': 'Downloading...',
    'settings.downloadProgress': 'Downloading {percent}%',
    'settings.readyToInstall': 'Ready to install',
    'settings.installRestart': 'Install & Restart',
    'settings.updateError': 'Update check failed',
    'settings.version': 'Version',
    'settings.language': 'Language',
    'settings.languageDesc': 'Interface language',
    'settings.terminal': 'Terminal',
    'settings.terminalDesc': 'Terminal for running commands',
    'settings.terminalSet': 'Terminal updated',
    'settings.shortcut': 'Global shortcut',
    'settings.shortcutDesc': 'Activate window from anywhere',
    'settings.pressKeys': 'Press keys...',
    'settings.shortcutSet': 'Shortcut registered',
    'settings.shortcutConflict': 'Shortcut already in use',
    'settings.shortcutFailed': 'Failed to register shortcut',
    'settings.shortcutCleared': 'Shortcut cleared',
    'settings.data': 'Data',
    'settings.dataDesc': 'Import or export project data',
    'settings.import': 'Import',
    'settings.export': 'Export',
    'msg.imagePasted': 'Image pasted',
  },
  zh: {
    'sidebar.title': '项目',
    'sidebar.newProject': '新建项目 (⌘N)',
    'sidebar.search': '搜索项目...',
    'welcome.title': 'CC 启动器',
    'welcome.subtitle': '选择一个项目或创建新项目',
    'welcome.shortcut': '添加项目',
    'details.edit': '编辑',
    'details.delete': '删除',
    'details.projectPath': '项目路径',
    'details.outputPath': '输出路径',
    'details.open': '打开',
    'details.commands': '命令',
    'modal.newProject': '新建项目',
    'modal.editProject': '编辑项目',
    'modal.projectName': '项目名称',
    'modal.projectNamePlaceholder': '我的项目',
    'modal.projectPath': '项目路径',
    'modal.selectProjectFolder': '选择项目文件夹',
    'modal.browse': '浏览',
    'modal.commands': '命令',
    'modal.addCommand': '+ 添加命令',
    'modal.outputPath': '输出路径',
    'modal.selectOutputFolder': '选择输出文件夹（可选）',
    'modal.cancel': '取消',
    'modal.save': '保存',
    'modal.browseFile': '选择文件',
    'modal.cmdName': '命名',
    'details.cmdName': '命名',
    'action.run': '运行',
    'msg.loadFailed': '加载项目失败',
    'msg.noMatch': '没有匹配的项目',
    'msg.noProjects': '暂无项目',
    'msg.emptyCommand': '命令不能为空',
    'msg.fillAllFields': '请填写所有字段并添加至少一条命令',
    'msg.projectUpdated': '项目已更新',
    'msg.projectAdded': '项目已添加',
    'msg.saveFailed': '保存失败',
    'msg.deleteTitle': '删除项目',
    'msg.deleteConfirm': '确定要删除 "{name}" 吗？此操作不可撤销。',
    'msg.projectDeleted': '项目已删除',
    'msg.deleteFailed': '删除失败',
    'msg.launching': '正在启动终端...',
    'msg.launched': '命令已在终端中启动',
    'msg.execFailed': '执行失败',
    'msg.exportFailed': '导出失败',
    'msg.exported': '设置已导出',
    'msg.invalidJson': '无效的 JSON 文件',
    'msg.imported': '已导入 {imported} 个，跳过 {skipped} 个',
    'msg.importFailed': '导入失败',
    'msg.minOneCommand': '至少需要一条命令',
    'confirm.cancel': '取消',
    'confirm.delete': '删除',
    'sidebar.settings': '设置',
    'settings.title': '设置',
    'settings.autoLaunch': '开机自启动',
    'settings.autoLaunchDesc': '登录系统时自动启动应用',
    'settings.autoLaunchOn': '已开启开机自启动',
    'settings.autoLaunchOff': '已关闭开机自启动',
    'settings.update': '软件更新',
    'settings.upToDate': '已是最新版本',
    'settings.checkUpdate': '检查更新',
    'settings.checking': '检查中...',
    'settings.newVersion': 'v{version} 可用',
    'settings.download': '下载',
    'settings.downloading': '下载中...',
    'settings.downloadProgress': '下载中 {percent}%',
    'settings.readyToInstall': '准备安装',
    'settings.installRestart': '安装并重启',
    'settings.updateError': '检查更新失败',
    'settings.version': '版本',
    'settings.language': '语言',
    'settings.languageDesc': '界面显示语言',
    'settings.terminal': '终端',
    'settings.terminalDesc': '执行命令使用的终端',
    'settings.terminalSet': '终端已更新',
    'settings.shortcut': '全局快捷键',
    'settings.shortcutDesc': '从任意位置激活窗口',
    'settings.pressKeys': '请按下快捷键...',
    'settings.shortcutSet': '快捷键已注册',
    'settings.shortcutConflict': '快捷键已被占用',
    'settings.shortcutFailed': '注册快捷键失败',
    'settings.shortcutCleared': '快捷键已清除',
    'settings.data': '数据',
    'settings.dataDesc': '导入或导出项目数据',
    'settings.import': '导入',
    'settings.export': '导出',
    'msg.imagePasted': '图片已粘贴',
  },
  ja: {
    'sidebar.title': 'プロジェクト',
    'sidebar.newProject': '新規プロジェクト (⌘N)',
    'sidebar.search': 'プロジェクトを検索...',
    'welcome.title': 'CC ランチャー',
    'welcome.subtitle': 'プロジェクトを選択するか、新規作成してください',
    'welcome.shortcut': 'プロジェクトを追加',
    'details.edit': '編集',
    'details.delete': '削除',
    'details.projectPath': 'プロジェクトパス',
    'details.outputPath': '出力パス',
    'details.open': '開く',
    'details.commands': 'コマンド',
    'modal.newProject': '新規プロジェクト',
    'modal.editProject': 'プロジェクトを編集',
    'modal.projectName': 'プロジェクト名',
    'modal.projectNamePlaceholder': 'マイプロジェクト',
    'modal.projectPath': 'プロジェクトパス',
    'modal.selectProjectFolder': 'プロジェクトフォルダを選択',
    'modal.browse': '参照',
    'modal.commands': 'コマンド',
    'modal.addCommand': '+ コマンドを追加',
    'modal.outputPath': '出力パス',
    'modal.selectOutputFolder': '出力フォルダを選択（任意）',
    'modal.cancel': 'キャンセル',
    'modal.save': '保存',
    'modal.browseFile': 'ファイルを選択',
    'modal.cmdName': '名前',
    'details.cmdName': '名前',
    'action.run': '実行',
    'msg.loadFailed': 'プロジェクトの読み込みに失敗',
    'msg.noMatch': '一致するプロジェクトがありません',
    'msg.noProjects': 'プロジェクトがありません',
    'msg.emptyCommand': 'コマンドを入力してください',
    'msg.fillAllFields': 'すべてのフィールドを入力し、少なくとも1つのコマンドを追加してください',
    'msg.projectUpdated': 'プロジェクトを更新しました',
    'msg.projectAdded': 'プロジェクトを追加しました',
    'msg.saveFailed': '保存に失敗しました',
    'msg.deleteTitle': 'プロジェクトを削除',
    'msg.deleteConfirm': '「{name}」を削除してもよろしいですか？この操作は取り消せません。',
    'msg.projectDeleted': 'プロジェクトを削除しました',
    'msg.deleteFailed': '削除に失敗しました',
    'msg.launching': 'ターミナルを起動中...',
    'msg.launched': 'ターミナルでコマンドを実行しました',
    'msg.execFailed': '実行に失敗しました',
    'msg.exportFailed': 'エクスポートに失敗しました',
    'msg.exported': '設定をエクスポートしました',
    'msg.invalidJson': '無効なJSONファイルです',
    'msg.imported': '{imported}件インポート、{skipped}件スキップ',
    'msg.importFailed': 'インポートに失敗しました',
    'msg.minOneCommand': '少なくとも1つのコマンドが必要です',
    'confirm.cancel': 'キャンセル',
    'confirm.delete': '削除',
    'sidebar.settings': '設定',
    'settings.title': '設定',
    'settings.autoLaunch': 'ログイン時に起動',
    'settings.autoLaunchDesc': 'システムログイン時に自動起動',
    'settings.autoLaunchOn': '自動起動を有効にしました',
    'settings.autoLaunchOff': '自動起動を無効にしました',
    'settings.update': 'ソフトウェア更新',
    'settings.upToDate': '最新バージョンです',
    'settings.checkUpdate': '確認',
    'settings.checking': '確認中...',
    'settings.newVersion': 'v{version} が利用可能',
    'settings.download': 'ダウンロード',
    'settings.downloading': 'ダウンロード中...',
    'settings.downloadProgress': 'ダウンロード中 {percent}%',
    'settings.readyToInstall': 'インストール準備完了',
    'settings.installRestart': 'インストールして再起動',
    'settings.updateError': '更新確認に失敗',
    'settings.version': 'バージョン',
    'settings.language': '言語',
    'settings.languageDesc': 'インターフェース言語',
    'settings.terminal': 'ターミナル',
    'settings.terminalDesc': 'コマンド実行用ターミナル',
    'settings.terminalSet': 'ターミナルを更新しました',
    'settings.shortcut': 'グローバルショートカット',
    'settings.shortcutDesc': 'どこからでもウィンドウを表示',
    'settings.pressKeys': 'キーを押してください...',
    'settings.shortcutSet': 'ショートカットを登録しました',
    'settings.shortcutConflict': 'ショートカットは既に使用中です',
    'settings.shortcutFailed': 'ショートカットの登録に失敗',
    'settings.shortcutCleared': 'ショートカットをクリアしました',
    'settings.data': 'データ',
    'settings.dataDesc': 'プロジェクトデータのインポート・エクスポート',
    'settings.import': 'インポート',
    'settings.export': 'エクスポート',
    'msg.imagePasted': '画像を貼り付けました',
  },
  fr: {
    'sidebar.title': 'Projets',
    'sidebar.newProject': 'Nouveau projet (⌘N)',
    'sidebar.search': 'Rechercher des projets...',
    'welcome.title': 'CC Launcher',
    'welcome.subtitle': 'Sélectionnez un projet ou créez-en un nouveau',
    'welcome.shortcut': 'pour ajouter un projet',
    'details.edit': 'Modifier',
    'details.delete': 'Supprimer',
    'details.projectPath': 'Chemin du projet',
    'details.outputPath': 'Chemin de sortie',
    'details.open': 'Ouvrir',
    'details.commands': 'Commandes',
    'modal.newProject': 'Nouveau projet',
    'modal.editProject': 'Modifier le projet',
    'modal.projectName': 'Nom du projet',
    'modal.projectNamePlaceholder': 'Mon projet',
    'modal.projectPath': 'Chemin du projet',
    'modal.selectProjectFolder': 'Sélectionner le dossier du projet',
    'modal.browse': 'Parcourir',
    'modal.commands': 'Commandes',
    'modal.addCommand': '+ Ajouter une commande',
    'modal.outputPath': 'Chemin de sortie',
    'modal.selectOutputFolder': 'Sélectionner le dossier de sortie (optionnel)',
    'modal.cancel': 'Annuler',
    'modal.save': 'Enregistrer',
    'modal.browseFile': 'Parcourir fichier',
    'modal.cmdName': 'Nom',
    'details.cmdName': 'Nom',
    'action.run': 'Exécuter',
    'msg.loadFailed': 'Échec du chargement des projets',
    'msg.noMatch': 'Aucun projet correspondant',
    'msg.noProjects': 'Aucun projet pour le moment',
    'msg.emptyCommand': 'La commande ne peut pas être vide',
    'msg.fillAllFields': 'Veuillez remplir tous les champs et ajouter au moins une commande',
    'msg.projectUpdated': 'Projet mis à jour',
    'msg.projectAdded': 'Projet ajouté',
    'msg.saveFailed': 'Échec de la sauvegarde',
    'msg.deleteTitle': 'Supprimer le projet',
    'msg.deleteConfirm': 'Êtes-vous sûr de vouloir supprimer « {name} » ? Cette action est irréversible.',
    'msg.projectDeleted': 'Projet supprimé',
    'msg.deleteFailed': 'Échec de la suppression',
    'msg.launching': 'Lancement du terminal...',
    'msg.launched': 'Commande lancée dans le terminal',
    'msg.execFailed': "Échec de l'exécution",
    'msg.exportFailed': "Échec de l'exportation",
    'msg.exported': 'Paramètres exportés',
    'msg.invalidJson': 'Fichier JSON invalide',
    'msg.imported': '{imported} importé(s), {skipped} ignoré(s)',
    'msg.importFailed': "Échec de l'importation",
    'msg.minOneCommand': 'Au moins une commande est requise',
    'confirm.cancel': 'Annuler',
    'confirm.delete': 'Supprimer',
    'sidebar.settings': 'Paramètres',
    'settings.title': 'Paramètres',
    'settings.autoLaunch': 'Lancer au démarrage',
    'settings.autoLaunchDesc': 'Démarrer automatiquement à la connexion',
    'settings.autoLaunchOn': 'Lancement automatique activé',
    'settings.autoLaunchOff': 'Lancement automatique désactivé',
    'settings.update': 'Mise à jour',
    'settings.upToDate': 'Vous êtes à jour',
    'settings.checkUpdate': 'Vérifier',
    'settings.checking': 'Vérification...',
    'settings.newVersion': 'v{version} disponible',
    'settings.download': 'Télécharger',
    'settings.downloading': 'Téléchargement...',
    'settings.downloadProgress': 'Téléchargement {percent}%',
    'settings.readyToInstall': "Prêt à installer",
    'settings.installRestart': 'Installer et redémarrer',
    'settings.updateError': 'Échec de la vérification',
    'settings.version': 'Version',
    'settings.language': 'Langue',
    'settings.languageDesc': "Langue de l'interface",
    'settings.terminal': 'Terminal',
    'settings.terminalDesc': 'Terminal pour exécuter les commandes',
    'settings.terminalSet': 'Terminal mis à jour',
    'settings.shortcut': 'Raccourci global',
    'settings.shortcutDesc': "Activer la fenêtre depuis n'importe où",
    'settings.pressKeys': 'Appuyez sur les touches...',
    'settings.shortcutSet': 'Raccourci enregistré',
    'settings.shortcutConflict': 'Raccourci déjà utilisé',
    'settings.shortcutFailed': "Échec de l'enregistrement du raccourci",
    'settings.shortcutCleared': 'Raccourci effacé',
    'settings.data': 'Données',
    'settings.dataDesc': 'Importer ou exporter les données de projet',
    'settings.import': 'Importer',
    'settings.export': 'Exporter',
    'msg.imagePasted': 'Image collée',
  },
};

const SUPPORTED_LOCALES = ['en', 'zh', 'ja', 'fr'];
const LOCALE_LABELS = { en: 'English', zh: '中文', ja: '日本語', fr: 'Français' };

// Translate a key with optional parameter interpolation
function t(key, params = {}) {
  const dict = translations[currentLocale] || translations.en;
  let text = dict[key] || translations.en[key] || key;
  for (const [k, v] of Object.entries(params)) {
    text = text.replace(`{${k}}`, v);
  }
  return text;
}

// Apply translations to all elements with data-i18n attributes
function applyLocale() {
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
    el.placeholder = t(el.dataset.i18nPlaceholder);
  });
  document.querySelectorAll('[data-i18n-title]').forEach((el) => {
    el.title = t(el.dataset.i18nTitle);
  });
  document.documentElement.lang = currentLocale === 'zh' ? 'zh-CN' : currentLocale;
}

// Set locale and persist
async function setLocale(locale) {
  if (!SUPPORTED_LOCALES.includes(locale)) return;
  currentLocale = locale;
  applyLocale();
  if (window.electronAPI?.setLocale) {
    await window.electronAPI.setLocale(locale);
  }
}

// Initialize locale from persisted setting or system
async function initLocale() {
  if (window.electronAPI?.getLocale) {
    const saved = await window.electronAPI.getLocale();
    if (saved && SUPPORTED_LOCALES.includes(saved)) {
      currentLocale = saved;
      applyLocale();
      return;
    }
  }
  // Fallback: detect from navigator
  const sysLang = (navigator.language || 'en').slice(0, 2);
  currentLocale = SUPPORTED_LOCALES.includes(sysLang) ? sysLang : 'en';
  applyLocale();
}